這套系統是一個基於 Python Streamlit 框架開發的自動化交貨單稽核平台，整合了 OCR、LLM（大型語言模型）與規則庫引擎。
一、 資料輸入與前處理層 (Input & Pre-processing)
1. 多源資料支援：
• 影像/文件：支援上傳 JPG, PNG, PDF（含多頁 PDF）。
• 結構化資料：支援直接上傳 Excel 檔（將表格轉文字後分析）或歷史 JSON 檔（回溯測試）。
2. Azure Document Intelligence (OCR)：
• 使用 Azure prebuilt-layout 模型進行文件佈局分析。
• 表格提取：自動辨識並標記「總表 (Summary Table)」與「明細表 (Detail Table)」。
• 分頁切割：支援將長文件依頁碼切割，並去除頁眉/頁尾雜訊（如簽核欄、標準條款）。
3. 並行處理 (Parallel Processing)：
• 使用 ThreadPoolExecutor (max_workers=4) 進行多執行緒處理，同時發送多頁 OCR 與 AI 請求，縮短等待時間。
二、 AI 解析與結構化層 (AI Parsing & Structuring)
1. LLM 整合 (Google Gemini)：
• 整合 Gemini 2.5 Flash 模型，負責語意理解與非結構化文字轉 JSON。
• 動態 Prompt：根據 OCR 內容，動態注入 Excel 中的 rules.xlsx 規格書作為 AI 的參考背景知識。
2. 資料結構化：
• 將雜亂文字轉換為標準 JSON 格式，包含：
• header_info：工令號、預定/實際交貨日。
• summary_rows：總表中的項目、申請數量、實交數量。
• dimension_data：明細項目、規格描述、目標數量、實測數值 (ds)。
三、 資料清洗與修復層 (Data Cleaning & Repair)
在進入邏輯判斷前，程式會先執行兩道修復程序：
1. 羅賓漢演算法 (Rebalance Orphan Data)：
• 功能：解決 OCR 斷行導致的數據錯位。
• 邏輯：當上一項數據短缺且下一項數據溢出時，自動將下一項的頭部數據搬移至上一項尾部，修復表格結構。
2. 強制更名系統 (Force Rename System)：
• 功能：標準化項目名稱，修正廠商筆誤或 OCR 雜訊。
• 邏輯：讀取 Excel Force_Rename 欄位。採用「包含 (Contains)」匹配邏輯（如：AI 識別出 #W3... 包含 Excel 關鍵字 W3），強制將名稱改為標準格式，確保後續規則能正確對應。
四、 四大核心稽核引擎 (Core Auditing Engines)
這是 Python 後端執行的硬邏輯檢查，不依賴 AI 幻覺。
1. 🏗️ 工程引擎 (Engineering Audit)
• 規格數值提取：使用 Regex 正則表達式從文字中提取毫米 (mm) 數值、公差 (±)、區間 (~)。
• 分類判定：依據項目名稱自動歸類（如：軸頸=上限管制、銲補=下限管制、精加工=區間管制）。
• 壞軌偵測：識別模糊、塗改或無法辨識的數值（標記為 [!]），判定為異常。
• 數值合規檢查：比對實測值 (ds) 是否落在規格標準 (std_spec) 計算出的公差範圍內。
2. 💰 會計引擎 (Accounting Audit)
• 總表/明細勾稽：自動加總所有分頁的明細數量，與首頁總表進行比對。
• 單位換算：解析標題中的單位邏輯（如 1SET=4PCS），自動將 SET 換算為 PCS 進行核對。
• 運費與歸戶 (Mode A/B)：
• Mode A：依數量倍率計算（如運費 x 數量）。
• Mode B (籃子撈人)：依關鍵字模糊匹配，將相關費用（拆裝、車修、銲補）歸戶至主件項目下進行加總核對。
• 隱藏/豁免處理：依據 Excel 規則排除 SKIP 或 EXEMPT 項目（如不計費項目）。
3. 🔄 流程引擎 (Process Audit)
• 製程溯源 (Genealogy)：
• 連坐檢查：檢查同一 ID 若有「軸頸」維修紀錄，是否具備對應的「本體」維修紀錄。
• 工序完整性 (Sequence Check)：
• 必要工序：若偵測到「銲補 (Stage 2)」，強制檢查後續是否存在「再生 (Stage 3)」。
• 防跳關：檢查是否跳過前置工序（如無粗車直接精車）。
• 物理邏輯檢查：比對前後工序的尺寸數值（例如：粗車尺寸必須小於/大於精車尺寸，視加工類型而定）。
4. 📝 表頭與合規引擎 (Header Audit)
• 工令淨化：使用 Regex 過濾雜訊，僅提取符合 W/R/O/Y 開頭且長度正確的工令號。
• 混單偵測：檢查整份文件中是否出現多個不同的工令號碼。
• 交期監控：比對 實際交貨日 是否晚於 預定交貨日。
五、 使用者介面與輸出 (UI & Output)
1. 卡片式報告：
• 將每個異常項目獨立為一張卡片，顯示來源（工程/會計/流程）、頁碼、異常原因與詳細數值對照表。
2. 紅綠燈狀態：
• 明細分頁：提供全項目列表，使用紅/綠燈號顯示該項目在「工程」、「會計」、「流程」三方面的合規狀態。
3. 規則透明化：
• 提供「Excel 邏輯檢視器」，顯示當前項目命中了 Excel 中的哪一條規則（含 Rename、Process、Unit Rule）。
4. 資料匯出：
• 支援將識別後的乾淨 JSON 資料打包下載，供後續資料庫串接或回測使用。